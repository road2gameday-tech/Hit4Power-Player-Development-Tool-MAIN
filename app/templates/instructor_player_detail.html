{% extends "base.html" %}
{% set title = player.name %}
{% block content %}
  <a href="/instructor" class="btn btn-ghost mb-1">← Back to Clients</a>

  <div class="player-header card">
    <div class="player-id">
      <div class="avatar">
        {% if player.image_path %}
          <img src="{{ player.image_path }}" alt="{{ player.name }}"/>
        {% else %}
          <div class="avatar-placeholder">{{ player.name[0] }}</div>
        {% endif %}
      </div>
      <div>
        <h2 class="player-name">{{ player.name }}</h2>
        <div class="muted">Login Code: {{ player.login_code }}</div>
      </div>
    </div>
    <button class="star" data-player="{{ player.id }}"><span class="star-shape">★</span></button>
  </div>

  <div class="grid two">
    <section class="card">
      <h3 class="section-title">Add Metrics</h3>
      <form method="post" action="/metrics/add" class="form">
        <input type="hidden" name="player_id" value="{{ player.id }}"/>
        <label>Date</label>
        <input type="date" name="date" value="{{ (namespace(d=cycler).__class__.__name__ and '') or '' }}" />
        <label>Exit Velocity</label>
        <input name="exit_velocity" type="number" step="0.1" placeholder="mph" />
        <label>Launch Angle</label>
        <input name="launch_angle" type="number" step="0.1" placeholder="deg" />
        <label>Spin Rate</label>
        <input name="spin_rate" type="number" step="0.1" placeholder="rpm" />
        <button class="btn btn-red">Save</button>
      </form>
      <ul class="list mt-1">
        {% for m in metrics %}
          <li>{{ m.date|datetimeformat }} — EV: {{ m.exit_velocity or 0 }}, LA: {{ m.launch_angle or 0 }}, SR: {{ m.spin_rate or 0 }}</li>
        {% else %}
          <li class="muted">No metrics yet.</li>
        {% endfor %}
      </ul>
    </section>

    <section class="card">
      <h3 class="section-title">Coach Notes</h3>
      <form method="post" action="/notes/add" class="form flex-row">
        <input type="hidden" name="player_id" value="{{ player.id }}"/>
        <textarea name="text" rows="2" placeholder="Write a private note to this player" required></textarea>
        <div class="checks">
          <label class="check"><input type="checkbox" name="share_with_player"> <span>Share on player dashboard</span></label>
          <label class="check"><input type="checkbox" name="text_player"> <span>Text player</span></label>
        </div>
        <button class="btn btn-red">Add</button>
      </form>
      <ul class="list mt-1">
        {% for n in notes %}
          <li>
            <div class="note-text">{{ n.text }}</div>
            <div class="note-meta">{{ n.created_at|datetimeformat }}{% if n.shared %} • <span class="a-red">Shared</span>{% endif %}</div>
          </li>
        {% else %}
          <li class="muted">No notes yet.</li>
        {% endfor %}
      </ul>
    </section>
  </div>

  <section class="card">
    <h3 class="section-title">Assign a Drill</h3>
    <form method="post" action="/drills/assign" class="form row">
      <input type="hidden" name="player_id" value="{{ player.id }}"/>
      <select name="drill_id" required>
        <option value="" disabled selected>Select a drill</option>
        {% for d in drills %}
          <option value="{{ d.id }}">{{ d.title }}</option>
        {% endfor %}
      </select>
      <input name="note" placeholder="Optional note"/>
      <button class="btn btn-red">Assign</button>
    </form>
  </section>

  <script>
    // star button on detail
    const starBtn = document.querySelector('.player-header .star');
    if (starBtn) {
      starBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const pid = starBtn.dataset.player;
        const res = await fetch(`/favorite/${pid}`, { method: 'POST' });
        const j = await res.json().catch(()=>({}));
        starBtn.querySelector('.star-shape').classList.toggle('on', j && j.favorited);
      });
    }
  </script>
{% endblock %}
