<!doctype html>
<html lang="en" data-theme="{{ request.cookies.get('theme','dark') }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clients • Hit4Power</title>
  <link rel="icon" href="{{ url_for('static', path='logo.svg') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body class="page">
  <header class="header">
    <a href="/" aria-label="Home">
      <img class="logo" src="{{ url_for('static', path='logo.svg') }}" alt="Hit4Power">
    </a>
    <nav class="nav">
      <a class="btn btn-outline-red" href="https://www.instagram.com/hit4.power/" target="_blank" rel="noopener">Instagram</a>
      <a class="btn btn-outline-red" href="https://www.hit4power.com/" target="_blank" rel="noopener">Website</a>
      <button id="themeToggle" class="btn btn-ghost" type="button">Toggle Theme</button>
      {% if session.get('role') == 'instructor' %}
        <a class="btn btn-red" href="/logout">Logout</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    {% if flash %}
      <div class="flash">{{ flash }}</div>
    {% endif %}

    <div class="card toolbar">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <strong>Clients</strong>
        <span class="muted small">Manage all players. Click ⭐ to add/remove from <em>My Clients</em>.</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="search" type="search" placeholder="Search players…" aria-label="Search players" />
        <select id="ageFilter" aria-label="Filter by age group">
          <option value="">All ages</option>
          <option>7-9</option>
          <option>10-12</option>
          <option>13-15</option>
          <option>16-18</option>
          <option>18+</option>
        </select>
      </div>
    </div>

    <div class="grid two">
      <!-- All Clients -->
      <section class="card">
        <h3 class="section-title">
          All Clients
          <span class="badge" id="allCount">0</span>
        </h3>
        <div id="allClients" class="roster"></div>
      </section>

      <!-- My Clients (starred) -->
      <section class="card">
        <h3 class="section-title">
          My Clients
          <span class="badge" id="starCount">0</span>
        </h3>
        <div id="starClients" class="roster"></div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <small class="muted">© {{ now().year }} Hit4Power</small>
    <div>
      <a class="btn btn-outline-red" href="https://www.instagram.com/hit4.power/" target="_blank" rel="noopener">Instagram</a>
      <a class="btn btn-outline-red" href="https://www.hit4power.com/" target="_blank" rel="noopener">Website</a>
    </div>
  </footer>

  <script>
    // THEME TOGGLE
    (function () {
      const root = document.documentElement;
      const key = 'h4p_theme';
      function setTheme(t) {
        root.setAttribute('data-theme', t);
        try { localStorage.setItem(key, t); } catch(e) {}
        document.cookie = "theme=" + t + "; path=/; max-age=31536000";
      }
      const saved = (localStorage.getItem(key) || null);
      if (saved) setTheme(saved);
      document.getElementById('themeToggle')?.addEventListener('click', () => {
        const next = (root.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
        setTheme(next);
      });
    })();

    // Data provided by server
    // Expect a list of players with: id, name, age_group, photo_url, starred (bool)
    const ALL_PLAYERS = {{ (players if players is defined else []) | tojson }};
    const INSTRUCTOR_ID = {{ (instructor_id if instructor_id is defined else 'null') }};

    // DOM refs
    const elAll = document.getElementById('allClients');
    const elStar = document.getElementById('starClients');
    const elAllCount = document.getElementById('allCount');
    const elStarCount = document.getElementById('starCount');
    const search = document.getElementById('search');
    const ageFilter = document.getElementById('ageFilter');

    function playerCard(p) {
      const initials = (p.name && p.name.trim().length) ? p.name.trim()[0].toUpperCase() : 'P';
      const starClass = p.starred ? 'star-shape on' : 'star-shape';
      return `
        <a href="/player/${p.id}" class="player-card" data-id="${p.id}" data-name="${p.name}" data-age="${p.age_group}">
          <div class="avatar ${p.photo_url ? '' : ''}">
            ${p.photo_url
              ? `<img src="${p.photo_url}" alt="${p.name}">`
              : `<div class="avatar-placeholder">${initials}</div>`
            }
          </div>
          <div class="player-meta">
            <div class="name">${p.name}</div>
            <div class="muted small">${p.age_group || ''}</div>
          </div>
          <button class="star" type="button" aria-label="Toggle favorite" data-star="${p.starred ? '1':'0'}" onclick="toggleStar(event, ${p.id})">
            <span class="${starClass}">★</span>
          </button>
        </a>
      `;
    }

    function render() {
      const q = (search.value || '').toLowerCase();
      const age = ageFilter.value || '';
      const list = ALL_PLAYERS.filter(p => {
        const matchesQ = !q || (p.name || '').toLowerCase().includes(q);
        const matchesAge = !age || (p.age_group === age);
        return matchesQ && matchesAge;
      });
      const starred = list.filter(p => !!p.starred);
      elAll.innerHTML = list.map(playerCard).join('');
      elStar.innerHTML = starred.map(playerCard).join('');
      elAllCount.textContent = list.length;
      elStarCount.textContent = starred.length;
    }

    search.addEventListener('input', render);
    ageFilter.addEventListener('change', render);

    // Optimistic star toggle + live "My Clients" update
    async function toggleStar(e, playerId) {
      e.preventDefault();
      e.stopPropagation();
      const p = ALL_PLAYERS.find(x => x.id === playerId);
      if (!p) return;

      const newVal = !p.starred;
      // Optimistic UI
      p.starred = newVal;
      render();

      try {
        // POST to API to persist
        const res = await fetch(`/api/players/${playerId}/toggle_star`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ instructor_id: INSTRUCTOR_ID })
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json(); // {starred: true/false}
        // Ensure UI matches server
        p.starred = !!data.starred;
        render();
      } catch(err) {
        // Revert on error
        p.starred = !newVal;
        render();
        alert('Could not update favorite. Please try again.');
      }
    }

    // expose for inline onclick
    window.toggleStar = toggleStar;

    // Initial paint
    render();
  </script>
</body>
</html>
