<!doctype html>
<html lang="en" data-theme="{{ request.cookies.get('theme', 'dark') }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player Dashboard • Hit4Power</title>
  <link rel="icon" href="{{ url_for('static', path='logo.svg') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .chart-wrap { height: 220px; }
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body class="page">
  <header class="header">
    <a href="/" aria-label="Home">
      <img class="logo" src="{{ url_for('static', path='logo.svg') }}" alt="Hit4Power">
    </a>
    <nav class="nav">
      <a class="btn btn-outline-red" href="https://www.instagram.com/hit4.power/" target="_blank" rel="noopener">Instagram</a>
      <a class="btn btn-outline-red" href="https://www.hit4power.com/" target="_blank" rel="noopener">Website</a>
      <button id="themeToggle" class="btn btn-ghost" type="button">Toggle Theme</button>
      {% if session.get('role') %}
        <a class="btn btn-red" href="/logout">Logout</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    {% if flash %}
      <div class="flash">{{ flash }}</div>
    {% endif %}

    <div class="card player-header">
      <div class="player-id">
        <div class="avatar">
          {% if player and player.photo_url %}
            <img src="{{ player.photo_url }}" alt="{{ player.name }}">
          {% else %}
            <div class="avatar-placeholder">{{ (player.name[:1] if player and player.name else 'P')|upper }}</div>
          {% endif %}
        </div>
        <div class="player-meta">
          <h2 class="player-name">{{ player.name if player else 'Player' }}</h2>
          <div class="muted small">Login code: {{ player.login_code if player and player.login_code else '—' }}</div>
        </div>
      </div>
    </div>

    <div class="grid two">
      <section class="card">
        <h3 class="section-title">Exit Velocity</h3>
        <div class="chart-wrap">
          <canvas id="velocityChart"></canvas>
        </div>
      </section>

      <section class="card">
        <h3 class="section-title">Coach Notes</h3>
        {% if coach_notes and coach_notes|length > 0 %}
          <ul class="list">
            {% for note in coach_notes %}
              <li class="card" style="margin:0;">
                <div class="note-text">{{ note.text }}</div>
                <div class="note-meta">by {{ note.coach_name }} • {{ note.created_at }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="muted">No notes yet. Your coach’s notes will appear here after sessions.</div>
        {% endif %}
      </section>
    </div>

    {% if drills and drills|length > 0 %}
      <section class="card">
        <h3 class="section-title">Assigned Drills</h3>
        <ul class="list">
          {% for d in drills %}
            <li class="card" style="margin:0;">
              <strong>{{ d.title }}</strong>
              {% if d.video_url %}
                <div class="mt-1 small">
                  <a class="a-red" href="{{ d.video_url }}" target="_blank" rel="noopener">Watch video</a>
                </div>
              {% endif %}
              {% if d.note %}
                <div class="mt-1 muted small">{{ d.note }}</div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </section>
    {% endif %}
  </main>

  <footer class="footer">
    <small class="muted">© {{ now().year }} Hit4Power</small>
    <div>
      <a class="btn btn-outline-red" href="https://www.instagram.com/hit4.power/" target="_blank" rel="noopener">Instagram</a>
      <a class="btn btn-outline-red" href="https://www.hit4power.com/" target="_blank" rel="noopener">Website</a>
    </div>
  </footer>

  <script>
    // Theme toggle
    (function () {
      const root = document.documentElement, key = 'h4p_theme';
      function setTheme(t){ root.setAttribute('data-theme', t); try{localStorage.setItem(key,t);}catch(e){}; document.cookie="theme="+t+"; path=/; max-age=31536000"; }
      const saved = (localStorage.getItem(key) || null); if (saved) setTheme(saved);
      document.getElementById('themeToggle')?.addEventListener('click', () => setTheme(root.getAttribute('data-theme')==='light'?'dark':'light'));
    })();

    // Exit Velocity chart (small, red line)
    (function () {
      const el = document.getElementById('velocityChart');
      if (!el) return;
      const labels = {{ (chart_labels if chart_labels is defined else []) | tojson }};
      const values = {{ (chart_values if chart_values is defined else []) | tojson }};

      new Chart(el, {
        type: 'line',
        data: { labels, datasets: [{ data: values, borderColor: '#e11d48', backgroundColor: 'rgba(225,29,72,0.15)', borderWidth: 2, pointRadius: 2, tension: 0.3, label: 'Exit Velo' }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
          scales: { x: { grid: { color: 'rgba(128,128,128,0.15)' } }, y: { beginAtZero: true, grid: { color: 'rgba(128,128,128,0.15)' } } }
        }
      });
    })();
  </script>
</body>
</html>
